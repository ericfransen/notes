#!/bin/bash

# This script checks for changes in your Obsidian vault and pushes them to GitHub.

# --- Find and Source Local Config ---
SOURCE=${BASH_SOURCE[0]}
while [ -L "$SOURCE" ]; do
  DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE
done
SCRIPT_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )

CONFIG_FILE="$SCRIPT_DIR/config.sh"

if [ ! -f "$CONFIG_FILE" ]; then exit 0; fi
source "$CONFIG_FILE"
if [ -z "$VAULT_PATH" ] || [ ! -d "$VAULT_PATH" ]; then exit 0; fi

# --- Main Sync Logic ---
cd "$VAULT_PATH" || exit 1
if [ ! -d ".git" ]; then exit 0; fi

# Clean volatile files
rm -f ./.obsidian/workspace.json ./.obsidian/workspaces.json

# Add, commit, and push if changes are detected
git add .
if ! git diff --staged --quiet; then
    git commit -m "chore: Daily sync $(date +'%Y-%m-%d %H:%M')"
    git push
fi

exit 0