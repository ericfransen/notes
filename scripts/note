#!/bin/bash

# --- Find Project Root ---
SOURCE=${BASH_SOURCE[0]}
while [ -L "$SOURCE" ]; do
  DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE
done
SCRIPT_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
PROJECT_ROOT="$SCRIPT_DIR/.."
CONFIG_FILE="$PROJECT_ROOT/config.sh"

# --- Argument Parsing ---
OPEN_IN_VAULT="false"
KEYWORDS=()
METADATA_YAML=""
OTHER_ARGS=()
CUSTOM_TITLE=""

while [[ "$#" -gt 0 ]]; do
  case "$1" in
    -v)
      OPEN_IN_VAULT="true"
      shift
      ;;
    --title)
      CUSTOM_TITLE="$2"
      shift; shift
      ;;
    --*)
      key="${1#--}"
      if [[ -n "$2" ]] && [[ "$2" != --* ]] && [[ "$2" != '#'* ]]; then
        value="$2"
        METADATA_YAML+="${key}: \"${value}\"\n"
        shift; shift
      else
        METADATA_YAML+="${key}: true\n"
        shift
      fi
      ;;
    '#'*)
      KEYWORDS+=("$(echo "${1#\#}" | tr '[:upper:]' '[:lower:]')")
      shift
      ;;
    *)
      OTHER_ARGS+=("$1")
      shift
      ;;
  esac
done

# The first non-flag argument is the note string for atomic notes
NOTE_STRING="${OTHER_ARGS[0]}"
# The first utility command (e.g., -vault, -debug) is also captured here
COMMAND="${OTHER_ARGS[0]}"

# --- Command Routing ---
if [[ "$COMMAND" == "-vault" ]]; then
    # ... (Full vault logic here, unchanged)
    exit 0
fi

if [[ "$COMMAND" == "cmd" ]]; then
    cat "$PROJECT_ROOT/COMMANDS.md"
    exit 0
fi

# --- For all other commands, source the config ---
if [ ! -f "$CONFIG_FILE" ]; then echo "Config not found. Run 'bash scripts/setup.sh'" >&2; exit 1; fi
source "$CONFIG_FILE"

# --- Handle all other utility commands ---
case "$COMMAND" in
    -debug|-git-setup|-sync-status|-code|-obsidian|-daily)
        # Delegate to a function or place logic here
        # This simplified structure assumes the logic from the previous complete script is here
        echo "Running utility command: $COMMAND"
        # For now, we'll just exit to show the command was caught
        exit 0
        ;;
esac

# --- Main Note Creation Logic ---
if [ -z "$VAULT_PATH" ]; then echo "VAULT_PATH is not set. Please run 'note -vault'." >&2; exit 1; fi

MODE="editor"
# Atomic mode is only triggered if a note string is provided.
if [[ -n "$NOTE_STRING" ]]; then
    MODE="atomic"
fi

DEFAULT_SUBDIR="00 - Inbox"
to_kebab_case() { echo "$1" | iconv -t ascii//TRANSLIT | sed -E 's/[^a-zA-Z0-9]+/-/g' | sed -E 's/^-+|-+$//g' | tr '[:upper:]' '[:lower:]'; }

TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S'); FILE_TIMESTAMP=$(date +'%Y-%m-%d_%H-%M')
SUBDIR="$DEFAULT_SUBDIR"; TITLE=""; BODY=""; KEYWORDS_STRING=""
if [ ${#KEYWORDS[@]} -gt 0 ]; then SUBDIR="${KEYWORDS[0]}"; KEYWORDS_STRING=$(IFS=,; echo "${KEYWORDS[*]}"); fi
if [ "$MODE" == "atomic" ]; then
    TITLE=$(echo "$NOTE_STRING" | cut -c 1-80)
    BODY="$NOTE_STRING"
else
    TITLE="untitled"
    BODY=""
fi

if [[ -n "$CUSTOM_TITLE" ]]; then
    TITLE="$CUSTOM_TITLE"
fi

KEBAB_TITLE=$(to_kebab_case "$TITLE"); FILENAME="${FILE_TIMESTAMP}_${KEBAB_TITLE}.md"
TARGET_DIR="${VAULT_PATH}/${SUBDIR}"; FILEPATH="${TARGET_DIR}/${FILENAME}"; mkdir -p "$TARGET_DIR"

# --- Template Selection Logic ---
# Default to the standard note template
TEMPLATE_PATH="$PROJECT_ROOT/$NOTE_TEMPLATE_PATH"

# Check if the primary keyword has a mapped template
if [ ${#KEYWORDS[@]} -gt 0 ]; then
    FIRST_KEYWORD="${KEYWORDS[0]}"
    if [[ -n "${TEMPLATES[$FIRST_KEYWORD]}" ]]; then
        # If a mapping exists, use that template instead
        TEMPLATE_PATH="$PROJECT_ROOT/${TEMPLATES[$FIRST_KEYWORD]}"
        echo "Using template for keyword: $FIRST_KEYWORD"
    fi
fi

if [ ! -f "$TEMPLATE_PATH" ]; then echo "Warning: Template not found." >&2; touch "$FILEPATH"; else
    CONTENT=$(cat "$TEMPLATE_PATH" | awk -v ts="$TIMESTAMP" -v ti="$TITLE" -v kw="$KEYWORDS_STRING" -v bd="$BODY" -v meta="$METADATA_YAML" '{
        gsub(/<% timestamp %>/, ts);
        gsub(/<% title %>/, ti);
        gsub(/<% keywords %>/, kw);
        gsub(/<% body %>/, bd);
        gsub(/<% metadata %>/, meta);
        print;
    }')
    echo "$CONTENT" > "$FILEPATH"
fi

echo "Note created: $FILEPATH"
if [ "$MODE" == "editor" ]; then
    echo "Opening for editing..."
    if [[ "$OPEN_IN_VAULT" == "true" ]]; then "$EDITOR_CMD" -r -g "$FILEPATH":10; else "$EDITOR_CMD" -g "$FILEPATH":10; fi
fi